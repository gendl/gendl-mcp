<!DOCTYPE HTML><html lang="en"><head><title>Writing output for download</title><meta charset="UTF-8" /><link rel="icon" type="image/png" href="/gorn.png" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="stylesheet" href="/css/training-style.css" /><script src="/static/3rdpty/x3dom/x3dom.js" id="x3dom_script"></script><script id="svg-panzoom" src="/static/3rdpty/svgpanzoom/svg-pan-zoom.min.js"></script><script>
var gdliid = '/shared';</script><script src="/static/gwl/js/gdlajax1595.js"></script></head><body><div class="container mx-auto"><div class="main-page-item"><div class="mt-1 ml-2 mr-5"><h2>Writing output for download</h2><p><a class="text-red-500" href="/websites/using-ajax/index.html">&lt;-Previous</a><span class="font-bold"> | </span><a class="text-blue-500" href="/websites/index.html">^UP^</a><span class="font-bold"> | </span><a class="text-green-500" href="/websites/file-io-2/index.html">Next-&gt;</a></p><div class="main-page-container"><div class="main-page-item"><div class="grid-container-2-650px"><div class="grid-item"><h3>Generating text output for download</h3><p>There is often a requirement to generate output as a file which can then be downloaded. There are 4 basic steps to this process<ul><li>Generate the file content</li><li>Write the content to either a static file or a html stream</li><li>Publish the output</li><li>Provide a link to the output on your web page</li></ul></p><h4><b><em>Generate the content</em></b></h4><p>In general this will involve writing a formatted string</p><div class="code-example"><pre><span class="code" style="margin-left: 0px;">(in-package :gwl-user)</span><span class="code" style="margin-left: 0px;"></span><span class="code" style="margin-left: 0px;">(define-object simple-file-output (base-html-page)</span><span class="code" style="margin-left: 7px;">(:computed-slots</span><span class="code" style="margin-left: 14px;">((file-contents (let ((line (list 1 2 3 4 5 6 7)))</span><span class="code" style="margin-left: 140px;">(format nil "~{Line ~a of my file~^~%~}" line))))</span><span class="code" style="margin-left: 14px;">))</span></pre></div><h4><b><em>Write the static output</em></b></h4><p>This is just standard file output, as described in the tutorial <em><b>File I/0</b></em> and its associated topic <em><b>Writing to a file</b></em></p><div class="code-example"><pre><span class="code" style="margin-left: 0px;">(in-package :gwl-user)</span><span class="code" style="margin-left: 0px;"></span><span class="code" style="margin-left: 0px;">(define-object simple-file-output (base-html-page)</span><span class="code" style="margin-left: 7px;">:computed-slots</span><span class="code" style="margin-left: 14px;">((file-contents (let ((line (list 1 2 3 4 5 6 7)))</span><span class="code" style="margin-left: 168px;">(format nil "~{Line ~a of my file~^~%~}" line)))</span><span class="code" style="margin-left: 0px;"></span><span class="code" style="margin-left: 21px;">(text-physical-file (let ((file-path (make-pathname :defaults (glisp:temporary-file)</span><span class="code" style="margin-left: 413px;">:type "txt")))</span><span class="code" style="margin-left: 217px;">(with-open-file (f file-path :direction :output :if-exists :supersede)</span><span class="code" style="margin-left: 266px;">(write-string (the file-contents) f))</span><span class="code" style="margin-left: 217px;">file-path))</span><span class="code" style="margin-left: 14px;">)</span></pre></div><p>The slot <span class="slot">text-physical-file</span> returns the pathname of the physical file. We'll cover writing the content directly to a html stream in the next part as its done at the same time as publishing</p><h4><b><em>Publish the output</em></b></h4><p>Publishing the output is done by <em>side affecting</em>. For the static file we define the url, write the static file to disc, publish the static file to the url and then return the url. (Note that the slot has been renamed in this example). For the output direct to the html stream we define a function as part of the publish to write the content on the fly and return the url.</p><div class="code-example"><pre><span class="code" style="margin-left: 0px;">(in-package :gwl-user)</span><span class="code" style="margin-left: 0px;"></span><span class="code" style="margin-left: 0px;">(define-object simple-file-output (base-html-page)</span><span class="code" style="margin-left: 7px;">:computed-slots</span><span class="code" style="margin-left: 14px;">((file-contents (let ((line (list 1 2 3 4 5 6 7)))</span><span class="code" style="margin-left: 168px;">(format nil "~{Line ~a of my file~^~%~}" line)))</span><span class="code" style="margin-left: 0px;"></span><span class="code" style="margin-left: 21px;">(text-physical-file-url (let ((url (format nil "/file-output-~a.txt" (get-current-date-time)))</span><span class="code" style="margin-left: 287px;">(file-path (make-pathname :defaults (glisp:temporary-file)</span><span class="code" style="margin-left: 518px;">:type "txt")))</span><span class="code" style="margin-left: 245px;">(with-open-file (f file-path :direction :output :if-exists :supersede)</span><span class="code" style="margin-left: 294px;">(write-string (the file-contents) f))</span><span class="code" style="margin-left: 245px;">(publish-file :path url</span><span class="code" style="margin-left: 343px;">:content-type "text/plain"</span><span class="code" style="margin-left: 343px;">:file file-path)</span><span class="code" style="margin-left: 252px;">url))</span><span class="code" style="margin-left: 21px;">(text-file-url (let ((url (format nil "/stream-output-~a.txt" (get-current-date-time))))</span><span class="code" style="margin-left: 154px;">(publish :path url</span><span class="code" style="margin-left: 238px;">:content-type "text/plain"</span><span class="code" style="margin-left: 238px;">:function #'(lambda(req ent)</span><span class="code" style="margin-left: 266px;">(with-http-response (req ent)</span><span class="code" style="margin-left: 287px;">(with-http-body (req ent)</span><span class="code" style="margin-left: 308px;">(write-string (the file-contents) *html-stream*)))))</span><span class="code" style="margin-left: 161px;">url))</span><span class="code" style="margin-left: 14px;">))</span></pre></div><p>Note that when publishing the stream output we have to provide a <span class="general-keyword">:function</span> argument to <span class="function">publish</span> function. We use a lambda function, and whilst it may appear somewhat complex it is a fairly standard boilerplate solution/syntax which may be used elsewhere</p><h4><b><em>Provide a link for download</em></b></h4><p>A <span class="object">page-section</span> is defined comprising links to each of the download options, and then displayed on the page by including its <span class="slot">div</span> in the <span class="slot">body</span> slot. Note the use of the :download atribute for the links, this ensures that on clicking the link the file is downloaded and gives the download file a name which appears in the browsers download window</p><div class="code-example"><pre><span class="code" style="margin-left: 0px;">(in-package :gwl-user)</span><span class="code" style="margin-left: 0px;"></span><span class="code" style="margin-left: 0px;">(define-object simple-file-output (base-html-page)</span><span class="code" style="margin-left: 7px;">:computed-slots</span><span class="code" style="margin-left: 7px;">(</span><span class="code" style="margin-left: 14px;">...</span><span class="code" style="margin-left: 14px;">...</span><span class="code" style="margin-left: 14px;">(body (with-lhtml-string ()</span><span class="code" style="margin-left: 98px;">(str (the development-links))</span><span class="code" style="margin-left: 98px;">(str (the export-section div))))</span><span class="code" style="margin-left: 7px;">)</span><span class="code" style="margin-left: 7px;">:objects</span><span class="code" style="margin-left: 7px;">(((export-section :type 'page-section</span><span class="code" style="margin-left: 161px;">:inner-html (with-lhtml-string ()</span><span class="code" style="margin-left: 266px;">(:p "Click "</span><span class="code" style="margin-left: 266px;">(:a :href (the text-file-url) </span><span class="code" style="margin-left: 294px;">:download "virtual-text-file.txt" "Here")</span><span class="code" style="margin-left: 273px;">" to download a virtual text file.")</span><span class="code" style="margin-left: 266px;">(:p "Click "</span><span class="code" style="margin-left: 266px;">(:a :href (the text-physical-file-url) </span><span class="code" style="margin-left: 301px;">:download "physical-text-file.txt" "Here")</span><span class="code" style="margin-left: 273px;">" to download a physical text file.")))))</span><span class="code" style="margin-left: 0px;">)</span></pre></div><image src="/t6-images/file-download.png" style="border: 2px solid; margin: 5px 0 0 3% ;width: auto; height: 300px;"></image></div></div><div class="main-page-item"><h2>Resources</h2><table><tr><td><a href="/t6-resources/gwl-patches.lisp"><img src="/common-images/lisp-file.png" style="width: 40px; height: auto;" /></a></td><td><a href="/t6-resources/gwl-patches.lisp">gwl-patches.lisp</a></td></tr><tr><td><a href="/t6-resources/simple-file-output.lisp"><img src="/common-images/lisp-file.png" style="width: 40px; height: auto;" /></a></td><td><a href="/t6-resources/simple-file-output.lisp">simple-file-output.lisp</a></td></tr></table></div></div></div></div></div></div></body></html>