<!DOCTYPE HTML><html lang="en"><head><title>Uploading files</title><meta charset="UTF-8" /><link rel="icon" type="image/png" href="/gorn.png" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="stylesheet" href="/css/training-style.css" /><script src="/static/3rdpty/x3dom/x3dom.js" id="x3dom_script"></script><script id="svg-panzoom" src="/static/3rdpty/svgpanzoom/svg-pan-zoom.min.js"></script><script>
var gdliid = '/shared';</script><script src="/static/gwl/js/gdlajax1595.js"></script></head><body><div class="container mx-auto"><div class="main-page-item"><div class="mt-1 ml-2 mr-5"><h2>Uploading files</h2><p><a class="text-red-500" href="/websites/file-io-1/index.html">&lt;-Previous</a><span class="font-bold"> | </span><a class="text-blue-500" href="/websites/index.html">^UP^</a><span class="font-bold"> | </span><a class="text-green-500" href="/websites/displaying-graphics/index.html">Next-&gt;</a></p><div class="main-page-container"><div class="main-page-item"><div class="grid-container-2-650px"><div class="grid-item"><h3>Uploading files</h3><p>To upload a file we need to submit a form, containing the file, to the server. This is a traditional multipart form submission.</p><p>Gendl provides the <span class="macro">with-form-string</span> macro to create a form. When using this macro for file uploads we must specify the keyword argunemt <span class="general-keyword">enctype</span> with a value of <em><b>multipart/form-data</b></em> to ensure the file is ransmited to the server correctly</p><p>Within the body of the form we need two <em><b>input</b></em> tags. <ul><li>The first is of type file which gives us a Browse button to enable a file to be selected. Within this tag we also need to assign a :name, the value of which must correspond with the name of a :settable :computed-slot (its symbol name, so preceeded witha : character). The default value of that slot shoud be an empty string</li><li>The second is a standard submit button, which submits the form</li></ul></p><div class="code-example"><pre><span class="code" style="margin-left: 0px;">(define-object file-upload-1 (base-html-page)</span><span class="code" style="margin-left: 14px;">:computed-slots</span><span class="code" style="margin-left: 14px;">((uploaded-path  " " :settable)</span><span class="code" style="margin-left: 21px;">(body</span><span class="code" style="margin-left: 35px;">(with-lhtml-string ()</span><span class="code" style="margin-left: 56px;">(str (the development-links))</span><span class="code" style="margin-left: 56px;">(str (with-form-string (:enctype  "multipart/form-data ")</span><span class="code" style="margin-left: 77px;">(:table (:tr (:td (:input :type  "file " :name :uploaded-path :value (the uploaded-path))))</span><span class="code" style="margin-left: 133px;">(:tr (:td (:input :type  "submit " :name  "upload " :value  "Upload "))</span><span class="code" style="margin-left: 133px;">(:td (str (the uploaded-path)))))))))))</span></pre></div><p>In the above example we also include an output of the value of <span class="slot">uploaded-path</span> The value of this slot is automatically set to the location of the uploaded file <b>on the server</b> when the form is submitted</p><p>Screenshot on opening the form </p><image src="/t6-images/upload-1.png" style="border: 2px solid; margin: 5px 0 0 3% ;width: auto; height: 160px;"></image><p>Once a file has been selected the <em><b>no file selected</b></em> text changes to the filename of the selected file. </p><p>Screenshot after selecting the file, but before hitting <em><b>Upload</b></em></p><image src="/t6-images/upload-1a.png" style="border: 2px solid; margin: 5px 0 0 3% ;width: auto; height: 160px;"></image><p>If <em><b>Upload</b></em> is then clicked the file is uploaded to the server and the text alongside the Browse button will revert to <em><b>no file selected</b></em>. As part of this upload, as well as transmitting the file to the server, the slot representing the server pathname to the file (in this case <span class="slot">:uploaded-path</span>) is set. One important thing to note: the default value for <span class="slot">uploaded-path</span> is set to an empty string, rather then nil. This is to ensure that when the <span class="slot">uploaded-path</span> value is set as part of the upload it is set to a string value and not a symbol - on Windows in particular with a drive letter followed by a <em><b>:</b></em> character this will cause problems as Lisp will believe its a package...</p><image src="/t6-images/upload-1b.png" style="border: 2px solid; margin: 5px 0 0 3% ;width: auto; height: 160px;"></image><p>It is often useful to conditionalise the display of the Browse and Submit buttons depending on the value of the uploaded file slot and
possibly present an alternative button which will reset the form to original values. The code below includes a <em><b>Reset</b></em> button to perform the reset. We use the <span class="function">after-set!</span> function, check what values are in the <span class="slot">query-plist</span> and if the value of this button <em><b>("Reset Form")</b></em> is present firstly delete the uploaded file if it exists and then run the <span class="function">restore-slot-default!</span> function on <span class="slot">upoaded-path</span></p><div class="code-example"><pre><span class="code" style="margin-left: 0px;">(define-object file-upload-2 (base-html-page)</span><span class="code" style="margin-left: 14px;">:computed-slots</span><span class="code" style="margin-left: 14px;">((uploaded-path  " " :settable)</span><span class="code" style="margin-left: 21px;">(body</span><span class="code" style="margin-left: 35px;">(with-lhtml-string ()</span><span class="code" style="margin-left: 56px;">(str (the development-links))</span><span class="code" style="margin-left: 56px;">(when (= (length (the uploaded-path)) 0)</span><span class="code" style="margin-left: 70px;">(htm (str (with-form-string (:enctype  "multipart/form-data ")</span><span class="code" style="margin-left: 91px;">(:table (:tr (:td (:input :type  "file " :name :uploaded-path :value (the uploaded-path))))</span><span class="code" style="margin-left: 147px;">(:tr (:td (:input :type  "submit " :name  "upload " :value  "Upload "))))))))</span><span class="code" style="margin-left: 56px;">(when (> (length (the uploaded-path)) 0)</span><span class="code" style="margin-left: 70px;">(htm (str (fmt  "The file has been uploaded to ~a" (the uploaded-path)))</span><span class="code" style="margin-left: 105px;">(str (with-form-string (:enctype "multipart/form-data")</span><span class="code" style="margin-left: 182px;">(:input :type "submit" :name "reset" :value "Reset Form")))))))</span><span class="code" style="margin-left: 7px;">:functions</span><span class="code" style="margin-left: 14px;">((after-set! ()</span><span class="code" style="margin-left: 84px;">(when (member "Reset Form" (the query-plist) :test 'equalp)</span><span class="code" style="margin-left: 119px;">(when (probe-file (the uploaded-path)) (delete-file (the uploaded-path)))</span><span class="code" style="margin-left: 119px;">(the (restore-slot-default! :uploaded-path ))))))</span></pre></div><p>Screenshot after hitting <em><b>Upload</b></em></p><image src="/t6-images/upload-2.png" style="border: 2px solid; margin: 5px 0 0 3% ;width: auto; height: 130px;"></image><p>Screenshot after hitting <em><b>Reset Form</b></em></p><image src="/t6-images/upload-3.png" style="border: 2px solid; margin: 5px 0 0 3% ;width: auto; height: 130px;"></image><p>Once the file has been uploaded to the server, it will generally need processing to access the data it contains. In the example below the uploaded file is processed as the page demands <span class="slot">(the file-content)</span> to be evaluated, but for more complex data processing we may use the <span class="function">after-set!</span> function, test for presence of the Upload Button value (<em><b>Upload</b></em>) in the <span class="slot">query-plist</span> and initiate processing based on that. (Note that the function <span class="function">read-file</span> is a custom function included in the resources file)</p><div class="code-example"><pre><span class="code" style="margin-left: 0px;">(define-object file-upload-3 (base-html-page)</span><span class="code" style="margin-left: 14px;">:computed-slots</span><span class="code" style="margin-left: 14px;">((uploaded-path  " " :settable)</span><span class="code" style="margin-left: 21px;">(body</span><span class="code" style="margin-left: 35px;">(with-lhtml-string ()</span><span class="code" style="margin-left: 56px;">(str (the development-links))</span><span class="code" style="margin-left: 56px;">(when (= (length (the uploaded-path)) 0)</span><span class="code" style="margin-left: 70px;">(htm (str (with-form-string (:enctype  "multipart/form-data ")</span><span class="code" style="margin-left: 91px;">(:table (:tr (:td (:input :type  "file " :name :uploaded-path :value (the uploaded-path))))</span><span class="code" style="margin-left: 147px;">(:tr (:td (:input :type  "submit " :name  "upload " :value  "Upload "))))))))</span><span class="code" style="margin-left: 56px;">(when (> (length (the uploaded-path)) 0)</span><span class="code" style="margin-left: 70px;">(htm (str (fmt  "The file has been uploaded to ~a" (the uploaded-path)))</span><span class="code" style="margin-left: 105px;">(:p "The file contents are")</span><span class="code" style="margin-left: 112px;">(:table :border 1 (:tr (:td :colspan 2 (str (first (first (the file-content))))))</span><span class="code" style="margin-left: 147px;">(dolist (line (cdr (the file-content)))</span><span class="code" style="margin-left: 182px;">(htm (:tr (:td (str (first line)))</span><span class="code" style="margin-left: 252px;">(:td (str (second line)))))))</span><span class="code" style="margin-left: 105px;">(str (with-form-string (:enctype "multipart/form-data")</span><span class="code" style="margin-left: 182px;">(:input :type "submit" :name "reset" :value "Reset Form")))))))</span><span class="code" style="margin-left: 7px;">:functions</span><span class="code" style="margin-left: 14px;">((after-set! ()</span><span class="code" style="margin-left: 84px;">(when (member "Reset Form" (the query-plist) :test 'equalp)</span><span class="code" style="margin-left: 119px;">(when (probe-file (the uploaded-path)) (delete-file (the uploaded-path)))</span><span class="code" style="margin-left: 119px;">(the (restore-slot-default! :uploaded-path ))))))</span></pre></div><image src="/t6-images/upload-4.png" style="border: 2px solid; margin: 5px 0 0 3% ;width: auto; height: 170px;"></image></div></div></div><div class="main-page-item"><h2>Resources</h2><table><tr><td><a href="/t6-resources/gwl-patches.lisp"><img src="/common-images/lisp-file.png" style="width: 40px; height: auto;" /></a></td><td><a href="/t6-resources/gwl-patches.lisp">gwl-patches.lisp</a></td></tr><tr><td><a href="/t6-resources/file-upload-1.lisp"><img src="/common-images/lisp-file.png" style="width: 40px; height: auto;" /></a></td><td><a href="/t6-resources/file-upload-1.lisp">file-upload-1.lisp</a></td></tr><tr><td><a href="/t6-resources/file-upload-2.lisp"><img src="/common-images/lisp-file.png" style="width: 40px; height: auto;" /></a></td><td><a href="/t6-resources/file-upload-2.lisp">file-upload-2.lisp</a></td></tr><tr><td><a href="/t6-resources/file-upload-3.lisp"><img src="/common-images/lisp-file.png" style="width: 40px; height: auto;" /></a></td><td><a href="/t6-resources/file-upload-3.lisp">file-upload-3.lisp</a></td></tr><tr><td><a href="/t6-resources/birthdays.txt"><img src="/common-images/txt-file.png" style="width: 40px; height: auto;" /></a></td><td><a href="/t6-resources/birthdays.txt">birthdays.txt</a></td></tr></table></div></div></div></div></div></body></html>